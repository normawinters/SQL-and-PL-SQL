-- CTE_SQL_above_average.sql
--Purpose: to find the employees whose salary is above the department average.
--uses the HR schema Oracle.
--Written 12/7/2025 Norma Winters


/*The CTE (dept_avg) computes the average salary per department.
The main query then: Joins employees with dept_avg to compare each employeeâ€™s   salary to their department average.

Also joins departments to display department names.
Only displays/returns employees whose salary is above the department average.

Note: see how the dept-avg is used, will help understand this sql.
*/


WITH dept_avg AS (
    SELECT 
        department_id,
        AVG(salary) AS avg_salary
    FROM 
        employees
    GROUP BY 
        department_id
)
SELECT 
    e.employee_id,
    e.first_name || ' ' || e.last_name AS employee_name,
    e.department_id,
    e.salary,
    d.department_name,
    da.avg_salary
FROM 
    employees e
    JOIN dept_avg da 
        ON e.department_id = da.department_id
    JOIN departments d 
        ON e.department_id = d.department_id
WHERE 
    e.salary > da.avg_salary
ORDER BY 
    e.department_id, e.salary DESC;

